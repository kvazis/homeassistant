############################################################################################################

- id: Энергомониторинг, расчет каждые 30 секунд
  alias: 00_power_counter
  initial_state: true
  trigger:
    - platform: time_pattern
      seconds: '/30'
  action:
    - service: script.turn_on
      entity_id:
##### Общее энергопотребление
        - script.total_power_day
##### ПРАЧЕЧНАЯ
##### Стиральная машина
        - script.842e14fffe51c5ae_day
##### КУХНЯ  
##### Телевизор Xiaomi
        - script.00158d0001291d12_day
##### Холодильник
        - script.00158d0001fa2934_day
##### LED лента
        - script.00158d0001d35bc0_day
##### Розетка Heiman
        -  script.000d6f0014bb14b4_day
##### Розетка Blitzwolf BW SHP-2
        - script.bw_shp_2_day
##### ГОСТИНАЯ
##### wifi + 2 USB
        - script.wifi_2usb_day
##### Гостиная телевизор
        - script.00158d00012896cb_day
##### Удлинитель - гостиная, стол
        - script.04cf8cdf3c764e0a_day
##### Батарея 2
    - service: mqtt.publish
      data_template:
        topic: "power/158d000114a1e1/today"
        payload: '{{(states.sensor.mqtt_power_today_158d000114a1e1.state | float +
                    (states.sensor.load_158d000114a1e1.state | float /120000))|round(5)}}'
        retain: true
    - service: mqtt.publish
      data_template:
        topic: "power/158d000114a1e1/month"
        payload: '{{(states.sensor.mqtt_power_month_158d000114a1e1.state | float +
                    (states.sensor.load_158d000114a1e1.state | float /120000))|round(5)}}'
        retain: true
##### Удлинитель 6 портов
    - service: script.turn_on
      entity_id: script.wifi_6port_day
##### Удлинитель 3+3
    - service: mqtt.publish
      data_template:
        topic: "power/wifi_3usb/today"
        payload: '{{(states.sensor.mqtt_power_today_wifi_3usb.state | float +
                    (states.sensor.load_wifi_3usb.state | float /120000))|round(5)}}'
        retain: true
    - service: mqtt.publish
      data_template:
        topic: "power/wifi_3usb/month"
        payload: '{{(states.sensor.mqtt_power_month_wifi_3usb.state | float +
                    (states.sensor.load_wifi_3usb.state | float /120000))|round(5)}}'
        retain: true

##### ВАННАЯ 
##### Бойлер
    - service: script.turn_on
      entity_id: script.00158d00015751f4_day

##### ДЕТСКАЯ Д
##### Ноутбук
    - service: script.turn_on
      entity_id: script.00158d000153dd8e_day
##### Выключатель Aqara Zero line - увлажнение и отопление
    - service: mqtt.publish
      data_template:
        topic: "power/158d0001a2ccab/today"
        payload: '{{(states.sensor.mqtt_power_today_158d0001a2ccab.state | float +
                    (states.sensor.load_158d0001a2ccab.state | float /120000))|round(5)}}'
        retain: true
    - service: mqtt.publish
      data_template:
        topic: "power/158d0001a2ccab/month"
        payload: '{{(states.sensor.mqtt_power_month_158d0001a2ccab.state | float +
                    (states.sensor.load_158d0001a2ccab.state | float /120000))|round(5)}}'
##### Настольная лампа
    - service: mqtt.publish
      data_template:
        topic: "power/158d00030a6e78/today"
        payload: '{{(states.sensor.mqtt_power_today_158d00030a6e78.state | float +
                    (states.sensor.load_158d00030a6e78.state | float /120000))|round(5)}}'
        retain: true
    - service: mqtt.publish
      data_template:
        topic: "power/158d00030a6e78/month"
        payload: '{{(states.sensor.mqtt_power_month_158d00030a6e78.state | float +
                    (states.sensor.load_158d00030a6e78.state | float /120000))|round(5)}}'
        retain: true

##### ДЕТСКАЯ А 
##### Реле Aqara отопление и рабочий стол
    - service: mqtt.publish
      data_template:
        topic: "power/158d0002d7bb2b/today"
        payload: '{{(states.sensor.mqtt_power_today_158d0002d7bb2b.state | float +
                    (states.sensor.load_158d0002d7bb2b.state | float /120000))|round(5)}}'
        retain: true
    - service: mqtt.publish
      data_template:
        topic: "power/158d0002d7bb2b/month"
        payload: '{{(states.sensor.mqtt_power_month_158d0002d7bb2b.state | float +
                    (states.sensor.load_158d0002d7bb2b.state | float /120000))|round(5)}}'
        retain: true
##### Увлажнитель А
    - service: mqtt.publish
      data_template:
        topic: "power/158d00010ec4b8/today"
        payload: '{{(states.sensor.mqtt_power_today_158d00010ec4b8.state | float +
                    (states.sensor.load_158d00010ec4b8.state | float /120000))|round(5)}}'
        retain: true
    - service: mqtt.publish
      data_template:
        topic: "power/158d00010ec4b8/month"
        payload: '{{(states.sensor.mqtt_power_month_158d00010ec4b8.state | float +
                    (states.sensor.load_158d00010ec4b8.state | float /120000))|round(5)}}'
        retain: true

        
############################################################################################################

- id: Энергомониторинг, начало нового дня
  alias: 00_power_new_day
  initial_state: true
  trigger:
    - platform: time
      at: '00:00:05'
  action:
    - service: script.turn_on
      entity_id:
##### Общее энергопотребление
        - script.total_power_yesterday
##### ПРАЧЕЧНАЯ
##### Стиральная машина
        - script.842e14fffe51c5ae_yesterday
##### КУХНЯ  
##### Телевизор Xiaomi
        - script.00158d0001291d12_yesterday
##### Холодильник
        - script.00158d0001fa2934_yesterday
##### Кухня LED лента
        - script.00158d0001d35bc0_yesterday
##### Розетка Heiman
        - script.000d6f0014bb14b4_yesterday
##### Розетка Blitzwolf BW SHP-2
        - script.bw_shp_2_yesterday
##### ГОСТИНАЯ
##### wifi + 2 USB
        - script.wifi_2usb_yesterday
##### Гостиная телевизор
        - script.00158d00012896cb_yesterday
##### Удлинитель - гостиная, стол
        - script.04cf8cdf3c764e0a_yesterday
##### Батарея 2
    - service: mqtt.publish
      data_template:
        topic: "power/158d000114a1e1/yesterday"
        payload: '{{(states.sensor.mqtt_power_today_158d000114a1e1.state | float )|round(5)}}'
        retain: true        
##### Удлинитель 6 портов
    - service: script.turn_on
      entity_id: script.wifi_6port_yesterday
##### Удлинитель 3+3        
    - service: mqtt.publish
      data_template:
        topic: "power/wifi_3usb/yesterday"
        payload: '{{(states.sensor.mqtt_power_today_wifi_3usb.state | float )|round(5)}}'
        retain: true

##### ВАННАЯ 
##### Бойлер
    - service: script.turn_on
      entity_id: script.00158d00015751f4_yesterday

##### ДЕТСКАЯ Д
##### Ноутбук
    - service: script.turn_on
      entity_id: script.00158d000153dd8e_yesterday
##### Выключатель Aqara Zero line - увлажнение и отопление
    - service: mqtt.publish
      data_template:
        topic: "power/158d0001a2ccab/yesterday"
        payload: '{{(states.sensor.mqtt_power_today_158d0001a2ccab.state | float )|round(5)}}'
        retain: true
##### Настольная лампа
    - service: mqtt.publish
      data_template:
        topic: "power/158d00030a6e78/yesterday"
        payload: '{{(states.sensor.mqtt_power_today_158d00030a6e78.state | float )|round(5)}}'
        retain: true

##### ДЕТСКАЯ А 
##### Реле Aqara отопление и рабочий стол
    - service: mqtt.publish
      data_template:
        topic: "power/158d0002d7bb2b/yesterday"
        payload: '{{(states.sensor.mqtt_power_today_158d0002d7bb2b.state | float )|round(5)}}'
        retain: true'
##### Увлажнитель А
    - service: mqtt.publish
      data_template:
        topic: "power/158d00010ec4b8/yesterday"
        payload: '{{(states.sensor.mqtt_power_today_158d00010ec4b8.state | float )|round(5)}}'
        retain: true
        
    - delay: 00:00:05

##### Обнуление данных текущего дня
##### ГОСТИНАЯ
##### Батарея 2      
    - service: mqtt.publish
      data_template:
        topic: "power/158d000114a1e1/today"
        payload: '{{ 0.0 }}'
        retain: true
##### Удлинитель 3+3 
    - service: mqtt.publish
      data_template:
        topic: "power/wifi_3usb/today"
        payload: '{{ 0.0 }}'
        retain: true

##### ДЕТСКАЯ Д
##### Выключатель Aqara Zero line - увлажнение и отопление      
    - service: mqtt.publish
      data_template:
        topic: "power/158d0001a2ccab/today"
        payload: '{{ 0.0 }}'
        retain: true
##### Настольная лампа
    - service: mqtt.publish
      data_template:
        topic: "power/158d00030a6e78/today"
        payload: '{{ 0.0 }}'
        retain: true

##### ДЕТСКАЯ А 
##### Реле Aqara отопление и рабочий стол       
    - service: mqtt.publish
      data_template:
        topic: "power/158d0002d7bb2b/today"
        payload: '{{ 0.0 }}'
        retain: true
##### Увлажнитель А        
    - service: mqtt.publish
      data_template:
        topic: "power/158d00010ec4b8/today"
        payload: '{{ 0.0 }}'
        retain: true
        
############################################################################################################

- id: Энергомониторинг, начало нового месяца
  alias: 00_power_new_month
  initial_state: true
  trigger:
    - platform: time
      at: '00:00:10'
  condition:
    - condition: template
      value_template: '{{ now().day == 1 }}'
  action:
    - service: script.turn_on
      entity_id:
##### Общее энергопотребление
        - script.total_power_lastmonth
##### ПРАЧЕЧНАЯ
##### Стиральная машина
        - script.842e14fffe51c5ae_lastmonth
##### КУХНЯ  
##### Телевизор Xiaomi
        - script.00158d0001291d12_lastmonth
##### Холодильник
        - script.00158d0001fa2934_lastmonth
##### Кухня LED лента  
        - script.00158d0001d35bc0_lastmonth
##### Розетка Heiman
        - script.000d6f0014bb14b4_lastmonth
##### Розетка Blitzwolf BW SHP-2
        - script.bw_shp_2_lastmonth
##### ГОСТИНАЯ
##### wifi + 2 USB
        - script.wifi_2usb_lastmonth
##### Гостиная телевизор
        - script.00158d00012896cb_lastmonth
##### Удлинитель - гостиная, стол
        - script.04cf8cdf3c764e0a_lastmonth
##### Батарея 2
    - service: mqtt.publish
      data_template:
        topic: "power/158d000153dd8e/lastmonth"
        payload: '{{(states.sensor.mqtt_power_month_158d000153dd8e.state | float )|round(5)}}'
        retain: true
##### Батарея 2 
    - service: mqtt.publish
      data_template:
        topic: "power/158d000114a1e1/lastmonth"
        payload: '{{(states.sensor.mqtt_power_month_158d000114a1e1.state | float )|round(5)}}'
        retain: true
##### Удлинитель 6 портов          
    - service: script.turn_on
      entity_id: script.wifi_6port_lastmonth
##### Удлинитель 3+3 
    - service: mqtt.publish
      data_template:
        topic: "power/wifi_3usb/lastmonth"
        payload: '{{(states.sensor.mqtt_power_month_wifi_3usb.state | float )|round(5)}}'
        retain: true

##### ВАННАЯ 
##### Бойлер
    - service: script.turn_on
      entity_id: script.00158d00015751f4_lastmonth

##### ДЕТСКАЯ Д
##### Ноутбук
    - service: script.turn_on
      entity_id: script.00158d000153dd8e_lastmonth
#### Выключатель Aqara Zero line - увлажнение и отопление  
    - service: mqtt.publish
      data_template:
        topic: "power/158d0001a2ccab/lastmonth"
        payload: '{{(states.sensor.mqtt_power_month_158d0001a2ccab.state | float )|round(5)}}'
        retain: true
##### Настольная лампа
    - service: mqtt.publish
      data_template:
        topic: "power/158d00030a6e78/lastmonth"
        payload: '{{(states.sensor.mqtt_power_month_158d00030a6e78.state | float )|round(5)}}'
        retain: true

##### ДЕТСКАЯ А 
##### Реле Aqara отопление и рабочий стол
    - service: mqtt.publish
      data_template:
        topic: "power/158d0002d7bb2b/lastmonth"
        payload: '{{(states.sensor.mqtt_power_month_158d0002d7bb2b.state | float )|round(5)}}'
        retain: true
##### Увлажнитель А
    - service: mqtt.publish
      data_template:
        topic: "power/158d00010ec4b8/lastmonth"
        payload: '{{(states.sensor.mqtt_power_month_158d00010ec4b8.state | float )|round(5)}}'
        retain: true

    - delay: 00:00:05
##### Обнуление данных текущего месяца
##### ГОСТИНАЯ
##### Батарея 2
    - service: mqtt.publish
      data_template:
        topic: "power/158d000114a1e1/month"
        payload: '{{ 0.0 }}'
        retain: true
##### Удлинитель 3+3 
    - service: mqtt.publish
      data_template:
        topic: "power/wifi_3usb/month"
        payload: '{{ 0.0 }}'
        retain: true

##### ДЕТСКАЯ Д
##### Выключатель Aqara Zero line - увлажнение и отопление
    - service: mqtt.publish
      data_template:
        topic: "power/158d0001a2ccab/month"
        payload: '{{ 0.0 }}'
        retain: true

##### Настольная лампа
    - service: mqtt.publish
      data_template:
        topic: "power/158d00030a6e78/month"
        payload: '{{ 0.0 }}'
        retain: true

##### ДЕТСКАЯ А
##### Реле Aqara отопление и рабочий стол       
    - service: mqtt.publish
      data_template:
        topic: "power/158d0002d7bb2b/month"
        payload: '{{ 0.0 }}'
        retain: true
##### Увлажнитель А        
    - service: mqtt.publish
      data_template:
        topic: "power/158d00010ec4b8/month"
        payload: '{{ 0.0 }}'
        retain: true